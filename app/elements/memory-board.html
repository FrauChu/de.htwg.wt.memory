<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/elements/memory-card.html">
<link rel="import" href="/elements/board-status.html">
<link rel="import" href="/elements/chat-area.html">
<!-- import the paper-button custom element -->
<link rel="import" href="/bower_components/paper-button/paper-button.html">

<dom-module name="memory-board">
	<style>
		div {
			padding-left: 4px;
			padding-right: 4px;
		}
		div.col-xs-4 {
			margin-top: -13px;
		}
	</style>

	<template id="memboard">
		<board-status id="statusb"></board-status>
		<div class="row">
			<template is="dom-repeat" items="{{widthcount}}" as="j">
				<div class="col-xs-1">
					<template is="dom-repeat" items="{{heigthcount}}" as="i">
						<memory-card posx="{{i}}" posy="{{j}}" memboardId="{{id}}"></memory-card>
					</template>
				</div>
			</template>
			<div class="col-xs-4">
				<chat-area id="chata"></chat-area>
			</div>
		</div>
		<paper-button raised on-click="clickHandler">Restart</paper-button> <!-- -->
	</template>

  <script>
	Polymer({
		is: "memory-board",
		listeners: {
		},
		properties: {
			size: {
				type: Object,
				observer: 'reloadBoard'
			},
			socket: {
				type: Object,
				value: {
					socket: null,
					cards: null,
					curData: null,
					
					init: function () {
						var origin = window.location.origin;
						if (origin.lastIndexOf("https", 0) == 0) {
							origin = origin.replace("https", "wss");
						} else if (origin.lastIndexOf("http", 0) == 0) {
							origin = origin.replace("http", "ws");
						}
						this.socket = new WebSocket(origin + "/socket");
						this.socket.onerror = this.onError.bind(this);
						this.socket.onopen = this.onOpen.bind(this);
						this.socket.onmessage = this.onMessage.bind(this);
					},
					onMessage: function(event) {
						this.curData = JSON.parse(event.data);
						if ("cards" in this.curData) {
							this.cards = this.curData.cards;
						}
						this.parent.checkSize(this.curData);
						this.parent.checkStatus(this.curData);
						this.parent.updateBoard();
						this.parent.checkAction(this.curData);
						this.parent.checkMessages(this.curData);
					},
					onError: function (error) {
						console.log("Error with web socket...");
						console.log(error);
					},
					onOpen: function (event) {
						console.log("WebSocket opened");
						var payload = new Object();
						payload.action = "get";
						this.send(JSON.stringify(payload));
						this._keepAlive();
					},
					send: function (message) {
						//console.log("Sending request. Payload: " + message);
						this.socket.send(message);
					},
					close: function () {
						this.socket.close();
					},
					getCard: function(x, y) {
						return this.cards[x][y];
					},
					pick: function(x, y) {
						var payload = new Object();
						payload.x = x;
						payload.y = y;
						payload.action = "pick";
						return this.send(JSON.stringify(payload));
					},
					_keepAlive: function() {
						// Heroku will end connections after 55 Seconds without traffic
						// So this method will produce traffic.
						(function(){
							var payload = new Object();
							payload.action = "keep-alive";
							socket = document.querySelector("#memboard").socket;
							if (socket.socket.readyState == 1) { // 1 = Open
								socket.send(JSON.stringify(payload));
								setTimeout(arguments.callee, 45000);
							} else {
								console.log("Socket in state " + socket.readyState);
							}
						})();
					}
				},
				readOnly: true
			}
		},
		ready: function() {
			this.socket.parent = this;
			this.socket.init();
			var chat = document.querySelector('chat-area');
			chat.socket = this.socket;
			this.async(function() {
				if (document.querySelector('div.col-xs-1') == null) {
					setTimeout(arguments.callee, 200);
					return;
				}
				$('chat-area > div.chatwindow').css('height', document.querySelector('div.col-xs-1').clientHeight + "px");
				$('chat-area > div.chatwindow > div').css('height', (document.querySelector('div.col-xs-1').clientHeight - 45) + "px");
			});
			
		},
		checkSize: function(resp) {
			if (!("width" in resp) || !("height" in resp)) {
				return;
			}
			var newsize = new Object();
			newsize.width = resp.width;
			newsize.height = resp.height;
			if (!this.size || newsize.width != this.size.width || newsize.height != this.size.height) {
				this.size = newsize;
			}
		},
		checkStatus: function(resp) {
			statusboard = document.querySelector("#statusb");
			if ("round" in resp) {
				statusboard.currentRound = resp.round;
			}
			if ("players" in resp) {
				statusboard.players = resp.players;
			}
			if ("currentPlayer" in resp) {
				statusboard.currentPlayer = resp.currentPlayer;
			}
			if ("scores" in resp) {
				statusboard.scores = resp.scores;
			}
		},
		checkMessages: function(resp) {
			chatArea = document.querySelector("#chata");
			if ("chatHistory" in resp) {
				chatArea.messages = resp.chatHistory;
			}
			//chatArea.scrollMax();
		},
		checkAction: function(resp) {
			if (!("actions" in resp)) {
				return;
			}
			for (i in resp.actions) {
				action = resp.actions[i]
				console.log("Processing action " + action.action);
				if (action.action == "end") {
					var overview = "Game has ended.";
					overview += "\nRounds played: " + action.rounds;
					overview += "\nScores:";
					for (j in action.playerScores) {
						overview += "\n\t" + action.playerScores[j].name + ":\t" + action.playerScores[j].points;
					}
					alert(overview);
				}
			}
		},
		reloadBoard: function() {
			//console.log('Reloading...');
			this.cards = [];
			this.widthcount = [];
			this.heigthcount = [];
			socket = this.socket;
			if(!socket) { socket = this.properties.socket.value; }
			for (i = 0; i < this.size.height; i++) {
				this.push('heigthcount', i);
				rowbase = Math.floor(i/2) * this.size.width;
				var row = [];
				for (j = 0; j < this.size.width; j++) {
					if (i == 0) { this.push('widthcount', j); }
					row[j] = "" + socket.cards[i][j];
				}
				//console.log("Pushing row " + row);
				this.push('cards', row);
			}
		},
		updateBoard: function() {
			cards = document.querySelectorAll("memory-card");
			for (var i = 0, element; element = cards[i]; i++) {
				element.reload++;
			}
		},
		clickHandler: function() {
			var payload = new Object();
			payload.action = "restart";
			this.socket.send(JSON.stringify(payload));
		}
	});
  </script>

</dom-module>